#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
require File.dirname(__FILE__)+'/../config/environment'
ActionMailer::Base.raise_delivery_errors = false
ActionMailer::Base.delivery_method = :test

# arguments
email = ARGV[0]  #TODO should use User ID in Gitorious
#user_id = ARGV[0]
key_file = ARGV[1]

user = User.find_by_email(email)
#user = User.find(user_id)
if !user
  puts "User with the given email address #{email} doesn't exist."
  exit 1
end


# Input the SSH key string from the file generated by the Lifthub web app.
key_str = ''
File::open(key_file) { |f|
  key_str = f.read
}

# Add SSH key
ssh_key = user.ssh_keys.new
ssh_key.key = key_str
ssh_key.ready = true

if ssh_key.save
  puts "SSH Key for user #{email} created successfully."
else
  puts "Failed creating SSH key for user #{email}."
  exit(1)
end

SshKey.add_to_authorized_keys(ssh_key.to_key)

# Display the ID so the caller can use it.
puts ssh_key.id
