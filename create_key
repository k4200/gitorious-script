#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
require File.dirname(__FILE__)+'/../config/environment'
ActionMailer::Base.raise_delivery_errors = false
ActionMailer::Base.delivery_method = :test

# arguments
user_id = ARGV[0]
key_file = ARGV[1]

#puts "user_id = #{user_id}"
#puts "key_file = #{key_file}" 

user = User.find(user_id)
if !user
  puts "User of id #{user_id} doesn't exist."
  exit 1
end


# Input the SSH key string from the file generated by the Lifthub web app.
key_str = ''
File::open(key_file) { |f|
  key_str = f.read
}

if key_str == ''
  puts "key_str is empty."
  exit 1
end


# Add SSH key
ssh_key = user.ssh_keys.new
ssh_key.key = key_str
ssh_key.ready = true

if ssh_key.save
  puts "SSH Key for user #{user_id} created successfully."
else
  puts "ssh key = '" + key_str + "'"
  puts "Failed creating SSH key for user #{user_id}."
  ssh_key.errors.each_full { |msg| puts msg }
  exit 1
end

if !SshKey.add_to_authorized_keys(ssh_key.to_key)
  puts "Failed to save SSH Key for user #{user_id}."
  exit 1
end

# Display the ID so the caller can use it.
puts ssh_key.id
